<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>USDT TRC20 Payment</title>
<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>

<style>
body{
  font-family: Arial;
  text-align:center;
  padding:40px;
  background:#f5f5f5;
}

.box{
  background:white;
  padding:30px;
  border-radius:12px;
  max-width:400px;
  margin:auto;
  box-shadow:0 0 20px rgba(0,0,0,0.1);
}

button{
  width:100%;
  padding:15px;
  margin-top:15px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

.pay{
  background:#16a34a;
  color:white;
}

.connect{
  background:#2563eb;
  color:white;
}

#status{
  margin-top:20px;
  word-break:break-all;
  font-size:14px;
}
</style>
</head>

<body>

<div class="box">

<h2>USDT TRC20 支付</h2>

<p>支付金額：</p>
<h1 id="amountText">--</h1>

<button class="connect" onclick="connectWallet()">連接錢包</button>
<button class="pay" onclick="pay()">確認支付</button>

<div id="status">等待錢包連接...</div>

</div>

<script>

const merchant = "TQnfMxpNrY9TjLYjMzHPDjSrDHYFhcripk";
const usdtContract = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";

let tronWeb = null;

// 讀取 URL 金額
function getAmount(){
  const params = new URLSearchParams(window.location.search);
  return params.get("amount");
}

document.getElementById("amountText").innerText =
  (getAmount() || "0") + " USDT";

// 等待 tronWeb 注入
function waitForTronWeb(){

  let attempts = 0;

  const check = setInterval(() => {

    if(window.tronWeb && window.tronWeb.defaultAddress.base58){

      tronWeb = window.tronWeb;

      document.getElementById("status").innerText =
        "已連接錢包：" + tronWeb.defaultAddress.base58;

      clearInterval(check);

    } else {

      attempts++;

      if(attempts > 20){
        clearInterval(check);
        document.getElementById("status").innerText =
          "未偵測到 TRON 錢包，請用 TokenPocket / TronLink 內建瀏覽器開啟";
      }

    }

  }, 500);

}

window.onload = function(){
  waitForTronWeb();
};

function connectWallet(){

  if(window.tronWeb && window.tronWeb.defaultAddress.base58){
    tronWeb = window.tronWeb;
    document.getElementById("status").innerText =
      "已連接：" + tronWeb.defaultAddress.base58;
  } else {
    alert("未偵測到 TRON 錢包");
  }

}

async function pay(){

  if(!tronWeb){
    alert("尚未連接錢包");
    return;
  }

  const amount = getAmount();

  if(!amount || amount <= 0){
    alert("金額錯誤");
    return;
  }

  try{

    const amountSun = tronWeb.toSun(amount);

    const contract = await tronWeb.contract().at(usdtContract);

    document.getElementById("status").innerText =
      "等待錢包確認交易...";

    const tx = await contract.transfer(
      merchant,
      amountSun
    ).send();

    document.getElementById("status").innerText =
      "交易已送出！TXID： " + tx;

  }catch(error){

    console.log("完整錯誤：", error);

    let raw = JSON.stringify(error);
    let friendly = "";

    if(raw.includes("OUT_OF_ENERGY")){
        friendly = "TRX 不足，無法支付手續費 (Energy 不足)";
    }
    else if(raw.includes("REVERT")){
        friendly = "USDT 餘額不足或合約拒絕";
    }
    else if(raw.includes("User rejected")){
        friendly = "使用者取消交易";
    }
    else if(raw.includes("balance is not sufficient")){
        friendly = "TRX 餘額不足";
    }
    else{
        friendly = error.message || raw;
    }

    document.getElementById("status").innerText =
      "交易失敗： " + friendly;

  }

}

</script>

</body>
</html>
