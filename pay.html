<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>USDT TRC20 Payment (TokenPocket)</title>

<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
<script src="https://unpkg.com/tp-js-sdk/dist/tp.min.js"></script>

<style>
body{
  font-family: Arial;
  text-align:center;
  padding:40px;
  background:#f5f5f5;
}

.box{
  background:white;
  padding:30px;
  border-radius:12px;
  max-width:400px;
  margin:auto;
  box-shadow:0 0 20px rgba(0,0,0,0.1);
}

button{
  width:100%;
  padding:15px;
  margin-top:15px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
  background:#16a34a;
  color:white;
}

#status{
  margin-top:20px;
  word-break:break-all;
  font-size:14px;
}
</style>
</head>

<body>

<div class="box">

<h2>USDT TRC20 支付</h2>

<p>支付金額：</p>
<h1 id="amountText">--</h1>

<button onclick="pay()">確認支付</button>

<div id="status">等待操作...</div>

</div>

<script>

const merchant = "TQnfMxpNrY9TjLYjMzHPDjSrDHYFhcripk";
const usdtContract = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";

// 讀取金額
function getAmount(){
  const params = new URLSearchParams(window.location.search);
  return params.get("amount");
}

document.getElementById("amountText").innerText =
  (getAmount() || "0") + " USDT";

async function pay(){

  if(!tp || !tp.isConnected()){
    document.getElementById("status").innerText =
      "請在 TokenPocket 內建瀏覽器打開";
    return;
  }

  const amount = getAmount();

  if(!amount || amount <= 0){
    alert("金額錯誤");
    return;
  }

  try{

    document.getElementById("status").innerText =
      "正在請求錢包簽名...";

    // 6 位小數
    const amountInt = parseInt(parseFloat(amount) * 1000000);

    // 構建合約調用資料
    const tronWeb = new TronWeb({
      fullHost: "https://api.trongrid.io"
    });

    const functionSelector = "transfer(address,uint256)";
    const parameter = [
      { type: "address", value: merchant },
      { type: "uint256", value: amountInt }
    ];

    const options = {
      feeLimit: 100000000
    };

    const transaction = await tronWeb.transactionBuilder.triggerSmartContract(
      usdtContract,
      functionSelector,
      options,
      parameter,
      await tp.getCurrentWallet().then(res => res.data.address)
    );

    if(!transaction.result.result){
      throw new Error("建立交易失敗");
    }

    // ⭐ 用 TokenPocket 簽名
    const signedTx = await tp.tronSignTransaction(transaction.transaction);

    // ⭐ 廣播
    const broadcast = await tronWeb.trx.sendRawTransaction(signedTx);

    if(broadcast.result){
      document.getElementById("status").innerText =
        "交易成功！TXID: " + signedTx.txID;
    }else{
      throw new Error("廣播失敗");
    }

  }catch(error){

    console.log(error);

    document.getElementById("status").innerText =
      "交易失敗：" + (error.message || JSON.stringify(error));

  }

}

</script>

</body>
</html>
