<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>USDT TRC20 Payment</title>
<script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>

<style>
body{
  font-family: Arial;
  text-align:center;
  padding:40px;
  background:#f5f5f5;
}

.box{
  background:white;
  padding:30px;
  border-radius:12px;
  max-width:400px;
  margin:auto;
  box-shadow:0 0 20px rgba(0,0,0,0.1);
}

button{
  width:100%;
  padding:15px;
  margin-top:15px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

.pay{
  background:#16a34a;
  color:white;
}

#status{
  margin-top:20px;
  word-break:break-all;
  font-size:14px;
}
</style>
</head>

<body>

<div class="box">

<h2>USDT TRC20 支付</h2>

<p>支付金額：</p>
<h1 id="amountText">--</h1>

<button class="pay" onclick="pay()">確認支付</button>

<div id="status">正在請求錢包授權...</div>

</div>

<script>

const merchant = "TQnfMxpNrY9TjLYjMzHPDjSrDHYFhcripk";
const usdtContract = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";

let tronWeb;

// 讀取 URL 金額
function getAmount(){
  const params = new URLSearchParams(window.location.search);
  return params.get("amount");
}

document.getElementById("amountText").innerText =
  (getAmount() || "0") + " USDT";

// ⭐ 強制請求錢包授權
async function requestWallet(){

  if(!window.tronWeb){
    document.getElementById("status").innerText =
      "請使用 TokenPocket / TronLink 內建瀏覽器開啟";
    return;
  }

  try{

    // 強制彈出授權
    await window.tronLink.request({ method: 'tron_requestAccounts' });

    tronWeb = window.tronWeb;

    document.getElementById("status").innerText =
      "已連接錢包：" + tronWeb.defaultAddress.base58;

  }catch(err){

    document.getElementById("status").innerText =
      "未授權錢包";

  }

}

window.onload = requestWallet;

async function pay(){

  if(!tronWeb){
    alert("尚未授權錢包");
    return;
  }

  const amount = getAmount();

  if(!amount || amount <= 0){
    alert("金額錯誤");
    return;
  }

  try{

    const amountInt = tronWeb.toBigNumber(amount)
        .times(1000000)
        .integerValue()
        .toString();

    const contract = await tronWeb.contract().at(usdtContract);

    document.getElementById("status").innerText =
      "等待錢包確認交易...";

    const tx = await contract.methods.transfer(
      merchant,
      amountInt
    ).send({
      feeLimit: 100000000
    });

    document.getElementById("status").innerText =
      "交易成功！TXID： " + tx;

  }catch(error){

    console.log(error);

    let raw = JSON.stringify(error);
    let msg = "";

    if(raw.includes("OUT_OF_ENERGY")){
        msg = "TRX 或 Energy 不足";
    }
    else if(raw.includes("REVERT")){
        msg = "USDT 餘額不足";
    }
    else if(raw.includes("User rejected")){
        msg = "使用者取消交易";
    }
    else{
        msg = error.message || raw;
    }

    document.getElementById("status").innerText =
      "交易失敗：" + msg;

  }

}

</script>

</body>
</html>
